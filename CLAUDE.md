# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Interview Hub is a Spring Boot 4.0.2 application for managing technical interviews and shadowing requests. It uses Java 25, PostgreSQL with JPA/Hibernate, Google OAuth2 authentication (restricted to @gm2dev.com accounts), and Google Calendar integration for managing interview events.

## Build & Run Commands

**Build the project:**
```bash
./gradlew build
```

**Build the Docker image:**
```bash
./gradlew bootBuildImage
```

**Run the application (requires `.env` file with env vars):**
```bash
docker compose up
```

**Run tests:**
```bash
./gradlew test
```

**Run a single test class:**
```bash
./gradlew test --tests com.gm2dev.interview_hub.FullyQualifiedTestClassName
```

**Run a single test method:**
```bash
./gradlew test --tests com.gm2dev.interview_hub.FullyQualifiedTestClassName.methodName
```

**Clean build artifacts:**
```bash
./gradlew clean
```

## Architecture

### Package Structure

- `domain/` - JPA entities (Interview, Profile, ShadowingRequest)
- `repository/` - Spring Data JPA repositories
- `service/` - Business logic layer (InterviewService, ShadowingRequestService, AuthService, GoogleCalendarService, TokenEncryptionService)
- `service/dto/` - Data transfer objects
- `controller/` - REST controllers (InterviewController, ShadowingRequestController, AuthController)
- `config/` - Spring configuration (SecurityConfig, GoogleOAuthProperties, JwtProperties)
- `util/` - Utility classes (JsonbConverter)

### Core Domain Model

The application models a three-entity system:

1. **Profile** - Represents users (interviewers and shadowers). The `id` is a UUID generated by the app on first Google OAuth login. Stores encrypted Google OAuth tokens for Calendar API access.

2. **Interview** - Scheduled interviews with:
   - Reference to interviewer (Profile)
   - JSONB field for flexible candidate data storage
   - Google Calendar integration via `googleEventId` (server-managed)
   - Time window (startTime, endTime)
   - Status tracking (SCHEDULED, etc.)
   - One-to-many relationship with ShadowingRequests

3. **ShadowingRequest** - Requests from team members to observe interviews:
   - References to both Interview and shadower (Profile)
   - Status tracking (PENDING, APPROVED, etc.)
   - On approval, shadower is invited to the Google Calendar event

### Key Technical Details

**Authentication:**
- Login flow: `GET /auth/google` → Google consent → `GET /auth/google/callback` → returns app JWT
- `POST /auth/token` is a Postman-compatible endpoint: accepts `code` + `redirect_uri` form params and returns `{access_token, token_type, expires_in}`
- Only `@gm2dev.com` Google Workspace accounts are allowed — validated via `hd` claim both as OAuth hint and post-exchange assertion
- App issues its own HMAC-SHA256 JWTs (1-hour expiry); the `NimbusJwtEncoder` is constructed inside `AuthService`, not a Spring bean
- Google OAuth tokens (access + refresh) are AES-encrypted at rest using `TOKEN_ENCRYPTION_KEY`; the salt is derived deterministically from the key's `hashCode()` so decryption survives restarts
- Scopes requested: openid, email, profile, calendar.events

**Database:**
- PostgreSQL (Supabase-hosted) with JSONB support for semi-structured data
- Hibernate validation mode (`ddl-auto: validate`) - schema changes require Supabase migrations
- Database connection configured via environment variables (DB_URL, DB_USERNAME, DB_PASSWORD)

**Security:**
- OAuth2 Resource Server with HMAC-SHA256 JWT validation (app-issued tokens)
- Custom JWT converter extracts "role" claim and prefixes with "ROLE_"
- Stateless sessions (no server-side session management)
- Public endpoints: `/actuator/health`, `/auth/google`, `/auth/google/callback`, `/auth/token`
- All other endpoints require `Authorization: Bearer <token>`

**Google Calendar Integration:**
- Creating an interview → creates a Google Calendar event on the interviewer's calendar
- Updating an interview → updates the Calendar event
- Deleting an interview → cancels the Calendar event
- Approving a shadowing request → adds shadower as attendee to the Calendar event
- Calendar failures are logged but don't block the primary operation

**JSONB Handling:**
- `Interview.candidateInfo` (a `Map<String, Object>`) uses `@JdbcTypeCode(SqlTypes.JSON)` + `@Column(columnDefinition = "jsonb")` — the Hibernate 6 native approach
- A `JsonbConverter` (`AttributeConverter`) also exists in `util/` but is **not** currently applied to any entity

**Error Handling:**
- `GlobalExceptionHandler` (`@RestControllerAdvice`) maps `EntityNotFoundException` → 404, `IllegalStateException` → 409 Conflict

**Role Assignment:**
- New profiles created on first OAuth login default to `role = "interviewer"`. There is no admin role assignment flow.

**Logging:**
- DEBUG level enabled for application code and Spring Security
- Services use SLF4j (`@Slf4j` annotation)

## Testing

Two distinct test styles are used — never mix them:

**Controller Tests (`@WebMvcTest`):**
- Annotated `@WebMvcTest(XController.class)` + `@Import(SecurityConfig.class)` + `@ActiveProfiles("test")`
- Use `@MockitoBean` (Spring Boot 3.4+ API) for the service layer, `JwtDecoder`, and `JwtProperties`
- Authenticate test requests using `.with(jwt())` from `spring-security-test`

**Service Tests (`@SpringBootTest`):**
- `@SpringBootTest` + `@ActiveProfiles("test")` + `@Transactional` + `@Rollback` — full Spring context with H2
- `GoogleCalendarService` is always `@MockitoBean`'d since it makes real HTTP calls
- `AuthServiceTest` and `GoogleCalendarServiceTest` use pure `@ExtendWith(MockitoExtension.class)` (no Spring context)
- These two services have package-private methods (`exchangeCodeForTokens`, `buildCalendarClient`) specifically to enable `spy()`-based interception without reflection

**Coverage:** JaCoCo enforces 80% branch coverage. `InterviewHubApplication` and `GoogleCalendarService` are excluded from coverage checks.

## Environment Variables

Required for runtime:
- `DB_URL` - PostgreSQL JDBC URL
- `DB_USERNAME` - Database username
- `DB_PASSWORD` - Database password
- `GOOGLE_CLIENT_ID` - Google OAuth2 client ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth2 client secret
- `JWT_SIGNING_SECRET` - HMAC-SHA256 key for app JWT signing (min 32 bytes)
- `TOKEN_ENCRYPTION_KEY` - AES key for encrypting Google OAuth tokens at rest
- `APP_BASE_URL` - Application base URL (default: http://localhost:8080)

## Dependencies

Key libraries:
- Spring Boot Web MVC
- Spring Data JPA with PostgreSQL
- Spring Security OAuth2 Resource Server + Client
- Google Calendar API v3
- Google Auth Library (OAuth2 HTTP)
- Lombok (code generation)
- Jackson (JSON processing for JSONB)
- H2 (test database)

## Database Schema Management

The application uses `hibernate.ddl-auto: validate`, meaning Hibernate will NOT create or modify the schema. Database migrations are managed via Supabase SQL files in `supabase/migrations/`. Tests use H2 with `ddl-auto: create-drop`.

## Local Development

To run locally:
1. Create a `.env` file in the project root with all required env vars (see Environment Variables above)
2. Build the image: `./gradlew bootBuildImage`
3. Start the container: `docker compose up`

No local database service is defined — the app connects to Supabase directly. Do NOT use `./gradlew bootRun`; the `spring-boot-docker-compose` devtools will attempt to manage Docker and fail if Docker Desktop's Linux engine isn't available.
- Health check: `GET /actuator/health`
- The `InterviewController` `listInterviews` endpoint accepts Spring Data `Pageable` query params (`page`, `size`, `sort`) automatically.
