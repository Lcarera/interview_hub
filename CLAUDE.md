# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Interview Hub is a Spring Boot 4.0.2 application for managing technical interviews and shadowing requests. It uses Java 25, PostgreSQL with JPA/Hibernate, Google OAuth2 authentication (restricted to @gm2dev.com accounts), and Google Calendar integration for managing interview events.

## Build & Run Commands

**Build the project:**
```bash
./gradlew build
```

**Run the application:**
```bash
./gradlew bootRun
```

**Run tests:**
```bash
./gradlew test
```

**Run a single test class:**
```bash
./gradlew test --tests com.gm2dev.interview_hub.FullyQualifiedTestClassName
```

**Run a single test method:**
```bash
./gradlew test --tests com.gm2dev.interview_hub.FullyQualifiedTestClassName.methodName
```

**Clean build artifacts:**
```bash
./gradlew clean
```

## Architecture

### Package Structure

- `domain/` - JPA entities (Interview, Profile, ShadowingRequest)
- `repository/` - Spring Data JPA repositories
- `service/` - Business logic layer (InterviewService, ShadowingRequestService, AuthService, GoogleCalendarService, TokenEncryptionService)
- `service/dto/` - Data transfer objects
- `controller/` - REST controllers (InterviewController, ShadowingRequestController, AuthController)
- `config/` - Spring configuration (SecurityConfig, GoogleOAuthProperties, JwtProperties)
- `util/` - Utility classes (JsonbConverter)

### Core Domain Model

The application models a three-entity system:

1. **Profile** - Represents users (interviewers and shadowers). The `id` is a UUID generated by the app on first Google OAuth login. Stores encrypted Google OAuth tokens for Calendar API access.

2. **Interview** - Scheduled interviews with:
   - Reference to interviewer (Profile)
   - JSONB field for flexible candidate data storage
   - Google Calendar integration via `googleEventId` (server-managed)
   - Time window (startTime, endTime)
   - Status tracking (SCHEDULED, etc.)
   - One-to-many relationship with ShadowingRequests

3. **ShadowingRequest** - Requests from team members to observe interviews:
   - References to both Interview and shadower (Profile)
   - Status tracking (PENDING, APPROVED, etc.)
   - On approval, shadower is invited to the Google Calendar event

### Key Technical Details

**Authentication:**
- Google OAuth2 login flow: `GET /auth/google` → Google consent → callback returns app JWT
- Only `@gm2dev.com` Google Workspace accounts are allowed (validated via `hd` claim)
- App issues its own HMAC-SHA256 JWTs for API authentication
- Google OAuth tokens (access + refresh) are AES-encrypted at rest on the Profile entity
- Scopes requested: openid, email, profile, calendar.events

**Database:**
- PostgreSQL (Supabase-hosted) with JSONB support for semi-structured data
- Hibernate validation mode (`ddl-auto: validate`) - schema changes require Supabase migrations
- Database connection configured via environment variables (DB_URL, DB_USERNAME, DB_PASSWORD)

**Security:**
- OAuth2 Resource Server with HMAC-SHA256 JWT validation (app-issued tokens)
- Custom JWT converter extracts "role" claim and prefixes with "ROLE_"
- Stateless sessions (no server-side session management)
- Public endpoints: `/actuator/health`, `/auth/google`, `/auth/google/callback`
- All other endpoints require authentication via `Authorization: Bearer <token>`

**Google Calendar Integration:**
- Creating an interview → creates a Google Calendar event on the interviewer's calendar
- Updating an interview → updates the Calendar event
- Deleting an interview → cancels the Calendar event
- Approving a shadowing request → adds shadower as attendee to the Calendar event
- Calendar failures are logged but don't block the primary operation

**JSONB Handling:**
- Custom `JsonbConverter` handles Map<String, Object> to PostgreSQL JSONB conversion
- Applied to Interview.candidateInfo field for flexible candidate data

**Logging:**
- DEBUG level enabled for application code and Spring Security
- Services use SLF4j (@Slf4j annotation)

## Environment Variables

Required for runtime:
- `DB_URL` - PostgreSQL JDBC URL
- `DB_USERNAME` - Database username
- `DB_PASSWORD` - Database password
- `GOOGLE_CLIENT_ID` - Google OAuth2 client ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth2 client secret
- `JWT_SIGNING_SECRET` - HMAC-SHA256 key for app JWT signing (min 32 bytes)
- `TOKEN_ENCRYPTION_KEY` - AES key for encrypting Google OAuth tokens at rest
- `APP_BASE_URL` - Application base URL (default: http://localhost:8080)

## Dependencies

Key libraries:
- Spring Boot Web MVC
- Spring Data JPA with PostgreSQL
- Spring Security OAuth2 Resource Server + Client
- Google Calendar API v3
- Google Auth Library (OAuth2 HTTP)
- Lombok (code generation)
- Jackson (JSON processing for JSONB)
- H2 (test database)

## Database Schema Management

The application uses `hibernate.ddl-auto: validate`, meaning Hibernate will NOT create or modify the schema. Database migrations are managed via Supabase migrations in `supabase/migrations/`.
